name: CI

on:
  [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          sudo apt install
          sudo apt install lcov cppcheck valgrind gcovr
          git submodule update --init
      - name: Build
        run: |
          mkdir _builds
          cd _builds
          cmake ..
          make all
      - name: Test common files
        run: |
          cd _builds
          ./test_common_files
      - name: Test consistent implementation
        run: |
          cd _builds
          ./test_consistent
      - name: Test parallel implementation
        run: |
          cd _builds
          ./test_parallel
      - name: Cppcheck
        run: |
          cppcheck --enable=all --suppress=missingInclude --error-exitcode=1 --inconclusive --language=c main.c common_functions/ parallel_implementation/ consistent_implementation/
      - name: Check valgrind common files
        run: |
          cd _builds
          valgrind --leak-check=full --error-exitcode=1 ./test_common_files
      - name: Check valgrind consistent implementation
        run: |
          cd _builds
          valgrind --leak-check=full --error-exitcode=1 ./test_consistent
      - name: Check valgrind parallel implementation
        run: |
          cd _builds
          valgrind --leak-check=full --error-exitcode=1 ./test_parallel
      - name: Check valgrind main consistent
        run: |
          cd _builds
          valgrind --leak-check=full --error-exitcode=1 ./main -i ../test/jump1.txt -o output.txt
      - name: Compare consistent and parallel implementations
        run: |
          mkdir result_of_comparison
          mkdir build_c
          cd build_c
          cmake ..
          make
          ./main -i ../test/jump6.txt -o ../result_of_comparison/consistent_result.txt
          cd ..
          mkdir build_p
          cd build_p
          cmake .. -DIS_STATIC=OFF
          make
          ./main -i ../test/jump6.txt -o ../result_of_comparison/parallel_result.txt
      - name: Result of comparison
        uses: actions/upload-artifact@v2
        with:
          name: result_of_comparison
          path: result_of_comparison
      - name: Create coverage
        run: |
          cd _builds
          ./test_common_files
          ./test_consistent
          ./test_parallel
          cd ..
          mkdir coverage_report
          gcovr -r . --exclude _builds/ --exclude build_c/ --exclude build_p/ --exclude main.c --html --html-details -o coverage_report/coverage.html
      - name: Code coverage report html
        uses: actions/upload-artifact@v2
        with:
          name: coverage_report
          path: coverage_report
      - name: Run clang-format style check
        uses: jidicula/clang-format-action@v4.3.0
        with:
          clang-format-version: '13'
          check-path: './common_functions ./consistent_implementation ./parallel_implementation ./test'
          exclude-regex: './_builds ./build_c ./build_p'
